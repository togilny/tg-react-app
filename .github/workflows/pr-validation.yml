name: PR Validation

on:
  pull_request:
    branches: [ "main", "develop" ]
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  validation:
    name: Validate Pull Request
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: PR Title Check
      uses: amannn/action-semantic-pull-request@v5
      continue-on-error: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Check for merge conflicts
      run: |
        git fetch origin ${{ github.base_ref }}
        if git merge-tree $(git merge-base HEAD origin/${{ github.base_ref }}) HEAD origin/${{ github.base_ref }} | grep -q "^<<<<<"; then
          echo "‚ö†Ô∏è Merge conflicts detected"
          exit 1
        else
          echo "‚úÖ No merge conflicts"
        fi

  backend-validation:
    name: Backend Code Quality
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET 9
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'

    - name: Restore dependencies
      working-directory: src/Server/TgReactApp.Api
      run: dotnet restore

    - name: Build
      working-directory: src/Server/TgReactApp.Api
      run: dotnet build --no-restore --configuration Release

    - name: Run tests with coverage
      working-directory: src/Server/TgReactApp.Api
      run: dotnet test --no-build --configuration Release --verbosity normal
      continue-on-error: true

    - name: Code analysis
      working-directory: src/Server/TgReactApp.Api
      run: dotnet build --no-restore /warnaserror
      continue-on-error: true

  frontend-validation:
    name: Frontend Code Quality
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: src/Web/tg-react-app.web/package-lock.json

    - name: Install dependencies
      working-directory: src/Web/tg-react-app.web
      run: npm ci

    - name: Run ESLint
      working-directory: src/Web/tg-react-app.web
      run: npm run lint
      continue-on-error: true

    - name: Check for console logs
      working-directory: src/Web/tg-react-app.web
      run: |
        if grep -r "console\\.log" src/ --include="*.jsx" --include="*.js"; then
          echo "‚ö†Ô∏è Warning: console.log statements found in code"
        else
          echo "‚úÖ No console.log statements found"
        fi
      continue-on-error: true

    - name: Build
      working-directory: src/Web/tg-react-app.web
      run: npm run build
      env:
        CI: true

    - name: Check bundle size
      working-directory: src/Web/tg-react-app.web
      run: |
        echo "üì¶ Bundle size analysis:"
        du -sh dist/*
        TOTAL_SIZE=$(du -sb dist | cut -f1)
        MAX_SIZE=$((10 * 1024 * 1024))  # 10MB
        if [ $TOTAL_SIZE -gt $MAX_SIZE ]; then
          echo "‚ö†Ô∏è Warning: Bundle size exceeds 10MB"
        else
          echo "‚úÖ Bundle size is acceptable"
        fi
      continue-on-error: true

  dependency-check:
    name: Security & Dependencies
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Check for vulnerabilities
      working-directory: src/Web/tg-react-app.web
      run: |
        npm audit --audit-level=moderate || true
        echo "Run 'npm audit fix' to fix vulnerabilities"

    - name: Check for outdated packages
      working-directory: src/Web/tg-react-app.web
      run: npm outdated || true

  pr-summary:
    name: PR Summary
    runs-on: ubuntu-latest
    needs: [validation, backend-validation, frontend-validation, dependency-check]
    if: always()
    
    steps:
    - name: PR Comment
      uses: actions/github-script@v7
      with:
        script: |
          const validation = '${{ needs.validation.result }}';
          const backend = '${{ needs.backend-validation.result }}';
          const frontend = '${{ needs.frontend-validation.result }}';
          const deps = '${{ needs.dependency-check.result }}';
          
          const statusEmoji = (status) => status === 'success' ? '‚úÖ' : status === 'failure' ? '‚ùå' : '‚ö†Ô∏è';
          
          const comment = `## PR Validation Summary
          
          | Check | Status |
          |-------|--------|
          | PR Validation | ${statusEmoji(validation)} ${validation} |
          | Backend Build | ${statusEmoji(backend)} ${backend} |
          | Frontend Build | ${statusEmoji(frontend)} ${frontend} |
          | Dependencies | ${statusEmoji(deps)} ${deps} |
          
          ${validation === 'success' && backend === 'success' && frontend === 'success' ? 'üéâ All checks passed! Ready for review.' : '‚ö†Ô∏è Some checks need attention. Please review the logs.'}
          
          ---
          *Automated by GitHub Actions*`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });

